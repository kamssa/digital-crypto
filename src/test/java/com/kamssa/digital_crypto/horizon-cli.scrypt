
Voici un exemple concret, propre et s√©curis√© pour votre serveur IBM HTTP Server.
Ce script fait un peu plus que juste red√©marrer : il v√©rifie que la commande existe et il √©crit dans le journal syst√®me (logs) pour laisser une trace de son ex√©cution.
√âtape 1 : Cr√©er le fichier
Ouvrez votre √©diteur (en tant que root) :
code
Bash
vi /opt/horizon/scripts/reload_ihs.sh
√âtape 2 : Coller le contenu suivant
(Copiez tout le bloc ci-dessous)
code
Bash
#!/bin/bash

# --- CONFIGURATION ---
# Chemin vers la commande de contr√¥le d'IBM HTTP Server
# V√©rifiez que ce chemin est correct sur votre machine (c'est le standard IBM)
IHS_BIN="/opt/IBM/HTTPServer/bin/apachectl"

# --- EXECUTION ---

# 1. On √©crit la date dans les logs pour dire qu'on commence
echo "$(date) - Horizon-CLI : Demande de rechargement du certificat SSL..." >> /tmp/horizon_reload.log

# 2. V√©rification que le binaire existe
if [ -f "$IHS_BIN" ]; then
    
    # 3. Lancement du rechargement "graceful" 
    # (Cela recharge la config et les certificats sans couper les utilisateurs connect√©s)
    $IHS_BIN -k graceful
    
    # V√©rification du r√©sultat
    if [ $? -eq 0 ]; then
        echo "$(date) - SUCCES : Serveur Web recharge avec succes." >> /tmp/horizon_reload.log
    else
        echo "$(date) - ERREUR : Echec du rechargement du serveur Web." >> /tmp/horizon_reload.log
        exit 1
    fi

else
    echo "$(date) - ERREUR : Le fichier $IHS_BIN est introuvable." >> /tmp/horizon_reload.log
    exit 1
fi

exit 0
√âtape 3 : Rendre le script ex√©cutable
C'est obligatoire, sinon horizon-cli ne pourra pas le lancer.
code
Bash
chmod +x /opt/horizon/scripts/reload_ihs.sh
√âtape 4 : Tester le script
Avant de l'int√©grer √† votre commande horizon, testez-le manuellement pour voir s'il ne fait pas d'erreur :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
Puis v√©rifiez le petit fichier de log qu'il a cr√©√© :
code
Bash
cat /tmp/horizon_reload.log
Si vous voyez "SUCCES", c'est parfait.
Comment l'utiliser dans votre commande Horizon ?
Dans la commande longue que vous construisez, √† la fin, pour le param√®tre script, vous mettrez simplement :
--post-hook="/opt/horizon/scripts/reload_ihs.sh"
(Note : parfois le param√®tre s'appelle --script ou --exec, v√©rifiez sur votre page wiki, mais le principe reste le chemin vers ce fichier).
/////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
Voici la proc√©dure compl√®te, moderne et automatis√©e, pour installer un certificat SSL sur votre serveur IBM HTTP Server (IHS) version 9 en utilisant horizon-cli.
Cette m√©thode remplace la "vieille" m√©thode manuelle (KDB) et garantit que le certificat se renouvellera tout seul l'ann√©e prochaine.
Phase 1 : Pr√©paration de l'automatisation (Le Script)
Avant de cr√©er le certificat, on pr√©pare le petit script qui servira √† recharger le serveur automatiquement lors des futurs renouvellements.
1. Cr√©er le fichier du script :
code
Bash
vi /opt/horizon/scripts/reload_ihs.sh
(Si le dossier scripts n'existe pas, cr√©ez-le avec mkdir -p /opt/horizon/scripts)
2. Coller ce contenu dedans :
Ce script dit au serveur Web de relire sa configuration sans couper les utilisateurs connect√©s.
code
Bash
#!/bin/bash
# Chemin vers la commande de contr√¥le IHS (A v√©rifier sur votre serveur)
IHS_BIN="/opt/IBM/HTTPServer/bin/apachectl"

# Ecriture dans un log pour le suivi
echo "$(date) - Horizon : Demande de rechargement..." >> /tmp/horizon_reload.log

if [ -f "$IHS_BIN" ]; then
    $IHS_BIN -k graceful
    if [ $? -eq 0 ]; then
        echo "$(date) - SUCCES : Serveur recharge." >> /tmp/horizon_reload.log
    else
        echo "$(date) - ERREUR : Echec du rechargement." >> /tmp/horizon_reload.log
        exit 1
    fi
else
    echo "$(date) - ERREUR : Binaire apachectl introuvable." >> /tmp/horizon_reload.log
    exit 1
fi
3. Rendre le script ex√©cutable (Obligatoire) :
code
Bash
chmod +x /opt/horizon/scripts/reload_ihs.sh
Phase 2 : Cr√©ation du certificat avec Horizon
Nous allons g√©n√©rer les fichiers .pem (certificat) et .key (cl√© priv√©e).
1. Construire la commande :
Remplacez VOTRE_SERVEUR par le vrai nom (ex: s02v19932112.fr.net.intra).
code
Bash
/opt/horizon/bin/horizon-cli automate enroll \
  --no-interactive \
  --automation-policy=automate-app-tls-server-365 \
  --target=generic \
  --auto-renew \
  --dnsnames="VOTRE_SERVEUR" \
  --contact-email="votre.email@echonet.net" \
  --post-hook="/opt/horizon/scripts/reload_ihs.sh"
Explication :
--target=generic : G√©n√®re des fichiers simples .pem et .key (lisibles par IHS 9).
--post-hook : Lie le script cr√©√© en Phase 1.
--auto-renew : Active le renouvellement automatique.
2. Noter le chemin des fichiers :
√Ä la fin de l'ex√©cution, Horizon va vous dire o√π il a mis les fichiers. Habituellement c'est dans :
/opt/horizon/var/generic/
Notez bien les noms exacts (ex: cert.pem, privkey.key, chain.pem).
Phase 3 : Configuration du Serveur Web (IHS)
C'est l'√©tape o√π on dit √† IBM HTTP Server : "Arr√™te de chercher un fichier KDB compliqu√©, et utilise ces nouveaux fichiers PEM".
1. Ouvrir le fichier de configuration :
code
Bash
vi /opt/IBM/HTTPServer/conf/httpd.conf
(Chemin standard, sinon utilisez menu_web > config)
2. Trouver et modifier la section SSL (<VirtualHost *:443>) :
Vous devez commenter (mettre un # devant) l'ancienne ligne KeyFile et ajouter les 3 nouvelles lignes pointant vers vos fichiers Horizon.
code
Apache
<VirtualHost *:443>
    SSLEnable

    # --- ANCIENNE CONFIG (A commenter) ---
    # KeyFile /applis/..../quelquechose.kdb
    
    # --- NOUVELLE CONFIG HORIZON (A ajouter) ---
    # 1. Le certificat public
    SSLCertificateFile /opt/horizon/var/generic/cert.pem
    
    # 2. La cl√© priv√©e
    SSLCertificateKeyFile /opt/horizon/var/generic/privkey.key
    
    # 3. La cha√Æne de certification (CA)
    SSLCertificateChainFile /opt/horizon/var/generic/chain.pem

    # (Assurez-vous que les noms de fichiers correspondent exactement 
    # √† ceux g√©n√©r√©s √† la Phase 2)
    
</VirtualHost>
Phase 4 : D√©marrage et V√©rification
Tout est pr√™t, il faut maintenant appliquer les changements.
1. Red√©marrer le serveur Web :
Le plus simple pour vous est d'utiliser le menu.
Tapez menu_web.
Faites Stop.
Faites Start.
(Ceci est n√©cessaire la premi√®re fois car on a modifi√© le fichier httpd.conf. Les prochaines fois, le script s'en chargera tout seul).
2. V√©rifier que √ßa marche :
V√©rifiez le statut : Assurez-vous que le serveur est "RUNNING" dans le menu.
Test local :
code
Bash
curl -v -k https://localhost/
Regardez si vous voyez une ligne Server certificate: avec les bonnes dates.
R√©sum√©
Vous avez maintenant :
‚úÖ G√©n√©r√© un certificat valide.
‚úÖ Configur√© votre serveur Web pour l'utiliser.
‚úÖ Mis en place un script pour que, l'ann√©e prochaine, vous n'ayez rien √† faire (Horizon t√©l√©chargera le nouveau certif et lancera le script de reload tout seul).
/////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////

C'est parti ! Voici la proc√©dure d√©finitive et sur-mesure pour votre serveur.
J'ai int√©gr√© les chemins exacts que nous avons d√©couverts gr√¢ce √† vos captures d'√©cran (ps -ef). Vous pouvez suivre ces √©tapes une par une en toute confiance.
√âtape 1 : Cr√©ation du script de rechargement automatique
Ce script servira √† horizon-cli pour dire au serveur : "J'ai renouvel√© le certificat, prends-le en compte !" sans couper vos utilisateurs.
Cr√©ez le dossier (s'il n'existe pas) et le fichier :
code
Bash
mkdir -p /opt/horizon/scripts
vi /opt/horizon/scripts/reload_ihs.sh
Copiez ce contenu exact (avec le bon chemin que nous avons trouv√©) :
code
Bash
#!/bin/bash

# --- CONFIGURATION (Chemin trouv√© via votre ps -ef) ---
IHS_BIN="/apps/WebSphere/WebServer/bin/apachectl"

# --- LOGS ---
LOG_FILE="/tmp/horizon_reload.log"
echo "$(date) - Horizon : Demande de rechargement SSL..." >> $LOG_FILE

# --- EXECUTION ---
if [ -f "$IHS_BIN" ]; then
    # On lance un reload "graceful" (douceur)
    $IHS_BIN -k graceful
    
    if [ $? -eq 0 ]; then
        echo "$(date) - SUCCES : Le serveur Web a recharg√© la config." >> $LOG_FILE
    else
        echo "$(date) - ERREUR : La commande a √©chou√©." >> $LOG_FILE
        exit 1
    fi
else
    echo "$(date) - ERREUR : Le fichier $IHS_BIN est introuvable." >> $LOG_FILE
    exit 1
fi
Rendez le script ex√©cutable (Obligatoire) :
code
Bash
chmod +x /opt/horizon/scripts/reload_ihs.sh
Testez-le tout de suite :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
(V√©rifiez ensuite avec cat /tmp/horizon_reload.log que vous avez bien un message de SUCC√àS).
√âtape 2 : G√©n√©ration du certificat avec Horizon
On g√©n√®re les fichiers .pem (lisibles) au lieu des .kdb (compliqu√©s).
Remplacez VOTRE_SERVEUR par le nom DNS complet de la machine (celui utilis√© dans l'URL, ex: s02v19932112.fr.net.intra ou un alias).
code
Bash
/opt/horizon/bin/horizon-cli automate enroll \
  --no-interactive \
  --automation-policy=automate-app-tls-server-365 \
  --target=generic \
  --auto-renew \
  --dnsnames="VOTRE_SERVEUR" \
  --contact-email="votre.email@echonet.net" \
  --post-hook="/opt/horizon/scripts/reload_ihs.sh"
Notez le r√©sultat : √Ä la fin, la commande va vous dire : "Certificate enrolled successfully". Elle va lister les fichiers cr√©√©s dans /opt/horizon/var/generic/.
Certificat : cert.pem (ou le nom du serveur.pem)
Cl√© : privkey.key (ou le nom du serveur.key)
Cha√Æne : chain.pem
√âtape 3 : Configuration du serveur Web (Le lien)
Nous allons modifier le fichier de configuration que nous avons identifi√© gr√¢ce √† votre capture d'√©cran.
Ouvrez le fichier :
code
Bash
vi /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf
Cherchez la section <VirtualHost *:443> (c'est souvent vers la fin du fichier).
Modifiez comme ceci :
Mettez un # devant la ligne KeyFile (pour la d√©sactiver).
Ajoutez les 3 lignes SSL qui pointent vers vos nouveaux fichiers.
code
Apache
<VirtualHost *:443>
    SSLEnable
    
    # --- ANCIENNE CONFIGURATION (On d√©sactive le KDB) ---
    # KeyFile /applis/19382-certi-00/ihs/.../quelquechose.kdb

    # --- NOUVELLE CONFIGURATION HORIZON ---
    # Adaptez les noms de fichiers selon ce que l'√©tape 2 a g√©n√©r√©
    
    # 1. Le certificat public
    SSLCertificateFile /opt/horizon/var/generic/cert.pem
    
    # 2. La cl√© priv√©e
    SSLCertificateKeyFile /opt/horizon/var/generic/privkey.key
    
    # 3. La cha√Æne de certification
    SSLCertificateChainFile /opt/horizon/var/generic/chain.pem
    
    # ... le reste de la config ne change pas ...
</VirtualHost>
√âtape 4 : V√©rification et Validation
Avant de crier victoire, on v√©rifie que le fichier de config ne contient pas d'erreur de frappe.
V√©rification de la syntaxe :
code
Bash
/apps/WebSphere/WebServer/bin/apachectl -t
Si √ßa r√©pond Syntax OK, c'est parfait !
Si √ßa r√©pond une erreur, relisez le fichier httpd.conf (v√©rifiez les chemins des fichiers .pem et .key).
Application finale :
Lancez votre script une derni√®re fois pour appliquer la config :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
Test Final :
Essayez d'acc√©der √† votre site en HTTPS ou faites un curl local :
code
Bash
curl -v -k https://localhost/
üéâ F√©licitations ! Votre serveur est maintenant s√©curis√© avec une m√©thode moderne.
Le serveur utilise des fichiers standards.
L'an prochain, horizon-cli renouvellera le
 fichier tout seul et lancera le script de reload sans que vous n'ayez rien √† faire.
 
 /////////////////
 cp /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf.bak /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf
 
 /////////////////////// process avec .kdb ///////////////////////////////////////////////////////////////
 
C'est une excellente question et la capture d'√©cran arrive √† point nomm√© !
Oui, c'est tout √† fait possible. IBM HTTP Server est "n√©" pour utiliser des fichiers .kdb.
Sur votre image, je vois que vous avez r√©ussi √† g√©n√©rer les fichiers :
certis-api.staging.echonet.kdb (Le coffre-fort)
certis-api.staging.echonet.sth (La cl√© du coffre)
Voici la proc√©dure exacte pour configurer votre serveur avec ces fichiers, en tenant compte de ce que je vois sur votre √©cran.
√âtape 1 : ‚ö†Ô∏è Probl√®me de droits (CRITIQUE)
Regardez votre capture d'√©cran :
Le processus httpd tourne avec l'utilisateur was (colonnes du haut).
Vos fichiers .kdb et .sth appartiennent √† root (lignes du bas).
Cons√©quence : Le serveur ne pourra pas lire le fichier et plantera au d√©marrage.
Solution :
Vous devez changer le propri√©taire des fichiers. Tapez cette commande dans le dossier actuel :
code
Bash
chown was:web certis-api.staging.echonet.*
(Cela donne les droits √† l'utilisateur was et au groupe web).
√âtape 2 : Trouver le "Label" (L'√©tiquette)
Dans un fichier .pem, il n'y a qu'un seul certificat. Dans un .kdb, il peut y en avoir plusieurs. Le serveur a besoin de savoir quel est le "nom interne" (alias) du certificat √† utiliser.
Vous avez la chance d'avoir l'outil gskcapicmd juste sous vos yeux (dans ce dossier). Utilisez-le pour lire le contenu du KDB :
code
Bash
./gskcapicmd -cert -list -db certis-api.staging.echonet.kdb -stashed
Le r√©sultat ressemblera √† ceci :
code
Text
Certificates found
* default, - personal, ! trusted
-   mon_certificat_alias
!   DigiCertCA
Notez bien le nom qui se trouve √† la ligne "personal" (ex: mon_certificat_alias ou souvent le nom DNS du serveur).
√âtape 3 : Configurer le serveur (httpd.conf)
Maintenant, on modifie le cerveau du serveur pour lui dire : "Utilise ce KDB".
1. Ouvrez le fichier de config :
(Utilisez le chemin trouv√© pr√©c√©demment)
code
Bash
vi /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf
2. Cherchez la section <VirtualHost *:443> et modifiez :
code
Apache
<VirtualHost *:443>
    SSLEnable

    # --- DESACTIVEZ LES LIGNES PEM (Si vous les aviez mises) ---
    # SSLCertificateFile ...
    # SSLCertificateKeyFile ...
    
    # --- ACTIVEZ LA CONFIGURATION KDB ---
    
    # 1. Le chemin vers votre fichier KDB (celui de la photo)
    KeyFile /apps/WebSphere/WebPlugins/bin/certis-api.staging.echonet.kdb
    
    # 2. Le nom de l'√©tiquette (trouv√© √† l'√©tape 2)
    SSLServerCert VOTRE_ALIAS_ICI
    
</VirtualHost>
Note sur l'emplacement : Sur la photo, vos fichiers sont dans /apps/WebSphere/WebPlugins/bin. Pour un test, c'est OK. Mais pour la "vraie vie" (Prod), il est plus propre de les d√©placer dans un dossier d√©di√© aux certificats (ex: /applis/19382-certi-00/ssl/) pour ne pas les m√©langer avec les ex√©cutables syst√®me.
√âtape 4 : Appliquer
V√©rifiez la syntaxe :
code
Bash
/apps/WebSphere/WebServer/bin/apachectl -t
Red√©marrez (ou Reload) :
Utilisez votre script ou le menu :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
R√©sum√© pour l'automatisation
Si vous choisissez cette m√©thode (KDB) :
Le serveur fonctionnera parfaitement.
MAIS l'automatisation horizon-cli sera cass√©e.
L'ann√©e prochaine, Horizon g√©n√©rera des .pem.
Votre serveur, lui, attendra un .kdb.
Il faudra donc, dans votre script reload_ihs.sh, ajouter des lignes de commandes complexes (avec gskcapicmd) pour convertir automatiquement les nouveaux PEM en KDB avant de relancer le serveur.
C'est pourquoi, si vous avez le choix, la m√©thode .pem (native IHS 9) reste la plus simple.
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.
/////////////////////////// nouvelle solution /////////////////////////////////////////////////////////

C'est parfaitement clair. J'ai analys√© vos 3 images :
Image 1 (Terminal noir) : On voit que vos outils IBM (gskcapicmd, gskcmd) sont dans /apps/WebSphere/WebPlugins/bin/.
Image 2 (Terminal noir avec commande √©chou√©e) : On voit que vous essayez d'exporter avec le label certis-api.staging.echonet.
Image 3 (Notepad++) : On voit le chemin pr√©cis o√π vous voulez que les fichiers soient stock√©s : /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl/.
Log : On voit que le dossier de log est /opt/horizon/var/.
Voici le script sur-mesure qui rassemble tout cela.
Le Script : convert_kdb_to_p12.sh
Ce script va :
Aller chercher le KDB dans votre dossier /ssl.
Utiliser l'outil IBM dans /WebPlugins/bin.
Cr√©er le P12 dans le m√™me dossier /ssl.
Donner les droits √† l'utilisateur was.
√âcrire tout ce qu'il fait dans /opt/horizon/var/convert_script.log.
1. Cr√©ation du fichier
code
Bash
vi /opt/horizon/scripts/convert_kdb_to_p12.sh
2. Contenu √† copier (Lisez bien les commentaires pour comprendre)
code
Bash
#!/bin/bash

# ==============================================================================
# 1. CONFIGURATION DES VARIABLES (C'est ici qu'on d√©finit les chemins)
# ==============================================================================

# Le dossier o√π se trouvent vos certificats (pris de votre image Notepad++)
SSL_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl"

# Le nom de vos fichiers
KDB_NAME="certis-api.staging.echonet.kdb"
P12_NAME="certis-api.staging.echonet.p12"

# Le chemin complet vers l'outil IBM (pris de votre image terminal)
GSK_TOOL="/apps/WebSphere/WebPlugins/bin/gskcapicmd"

# Le nom de l'√©tiquette (Alias) du certificat dans le KDB
# (D'apr√®s votre tentative de commande manuelle)
CERT_LABEL="certis-api.staging.echonet"

# Le mot de passe que vous voulez donner au fichier P12
# ‚ö†Ô∏è IMPORTANT : Mettez ici le mot de passe que Liberty (server.xml) attend !
P12_PASSWORD="passQual1" 

# Le fichier de Log (dans le dossier que vous m'avez montr√©)
LOG_FILE="/opt/horizon/var/convert_script.log"


# ==============================================================================
# 2. FONCTION DE JOURNALISATION (Pour √©crire dans le log proprement)
# ==============================================================================
log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
    echo "$1" # Affiche aussi √† l'√©cran
}

# ==============================================================================
# 3. EXECUTION DU TRAITEMENT
# ==============================================================================

log_msg "[START] D√©marrage du script de conversion KDB vers P12."

# V√©rification que l'outil IBM existe
if [ ! -f "$GSK_TOOL" ]; then
    log_msg "[ERREUR] L'outil gskcapicmd est introuvable ici : $GSK_TOOL"
    exit 1
fi

# V√©rification que le fichier KDB existe
if [ ! -f "$SSL_DIR/$KDB_NAME" ]; then
    log_msg "[ERREUR] Le fichier KDB source est introuvable ici : $SSL_DIR/$KDB_NAME"
    exit 1
fi

log_msg "[INFO] Conversion en cours..."
log_msg "       Source : $SSL_DIR/$KDB_NAME"
log_msg "       Cible  : $SSL_DIR/$P12_NAME"

# --- LA COMMANDE MAGIQUE ---
# Explication des options :
# -cert -export      : On veut sortir un certificat
# -db ...            : Le fichier source
# -stashed           : Utilise le fichier .sth cach√© pour ne pas taper le mot de passe KDB
# -label ...         : Quel certificat prendre ? (Celui d√©fini dans la variable)
# -target ...        : O√π le mettre
# -target_type pkcs12: Le format voulu par Liberty
# -target_pw ...     : Le mot de passe pour prot√©ger le nouveau fichier

"$GSK_TOOL" -cert -export \
    -db "$SSL_DIR/$KDB_NAME" \
    -stashed \
    -label "$CERT_LABEL" \
    -target "$SSL_DIR/$P12_NAME" \
    -target_type pkcs12 \
    -target_pw "$P12_PASSWORD"

# V√©rification du r√©sultat de la commande (0 = Succ√®s)
if [ $? -eq 0 ]; then
    log_msg "[SUCCES] Le fichier .p12 a √©t√© g√©n√©r√©."
    
    # --- GESTION DES PERMISSIONS (TRES IMPORTANT) ---
    # On donne le fichier √† l'utilisateur 'was' et au groupe 'web'
    # pour que le serveur d'application puisse le lire.
    
    chown was:web "$SSL_DIR/$P12_NAME"
    chmod 640 "$SSL_DIR/$P12_NAME"
    
    log_msg "[INFO] Permissions mises √† jour (chown was:web)."
else
    log_msg "[ERREUR] La conversion a √©chou√©. V√©rifiez le label ou le mot de passe."
    exit 1
fi

log_msg "[END] Fin du traitement."
exit 0
Comment utiliser ce script ?
√âtape 1 : Rendre le script ex√©cutable
Pour que Linux accepte de lancer ce fichier texte comme un programme :
code
Bash
chmod +x /opt/horizon/scripts/convert_kdb_to_p12.sh
√âtape 2 : Lancer le script
code
Bash
/opt/horizon/scripts/convert_kdb_to_p12.sh
√âtape 3 : V√©rifier que √ßa a march√©
Regardez si le fichier existe :
code
Bash
ls -l /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl/
Vous devriez voir le .p12 avec comme propri√©taire was.
Regardez le fichier de log :
code
Bash
cat /opt/horizon/var/convert_script.log
Explication d√©taill√©e pour votre compr√©hension
GSK_TOOL="..." : J'ai mis le chemin /apps/WebSphere/WebPlugins/bin/gskcapicmd. C'est le programme IBM qui sait lire les KDB. On utilise le chemin complet pour √™tre s√ªr que √ßa marche quel que soit l'endroit o√π on se trouve.
SSL_DIR="..." : J'ai mis le chemin compliqu√© trouv√© dans votre Notepad++. C'est l√† que le fichier KDB source doit se trouver (g√©n√©r√© par Horizon ou manuellement) et c'est l√† que le script posera le P12.
-stashed : C'est l'option la plus importante. Elle dit √† la commande : "Ne me demande pas le mot de passe du KDB, va le chercher tout seul dans le fichier .sth qui est juste √† c√¥t√©". Sans √ßa, le script bloquerait en attendant que vous tapiez un mot de passe.
chown was:web : √Ä la fin, on force le fichier √† appartenir √† l'utilisateur was. C'est vital car si le fichier appartient √† root (l'utilisateur qui lance le script), votre serveur Java (Liberty) ne pourra pas le lire et plantera au d√©marrage.
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.

////////////////////////////////// salotion robuste ///////////////////////////////////////
#!/bin/bash

# ==============================================================================
# 1. CONFIGURATION (Bas√©e sur vos captures d'√©cran)
# ==============================================================================

# Dossier des outils IBM (gskcapicmd / gskcmd)
GSK_DIR="/apps/WebSphere/WebPlugins/bin"

# Dossier SOURCE (O√π sont le KDB et le STH actuellement)
SRC_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl"

# Dossier DESTINATION (Dossier 'security' de Liberty/WAS)
DEST_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_backjava-prez-1/servers/sa-19382_certis_backjava-prez-1/resources/security"

# Nom de base des fichiers
BASE_NAME="certis-api.staging.echonet"
CERT_LABEL="certis-api.staging.echonet"

# Mot de passe pour le fichier P12 (Attendu par Liberty)
P12_PASSWORD="passQual1"

# Fichier de Log
LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# 2. FONCTION LOG
# ==============================================================================
log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# ==============================================================================
# 3. ETAPE 1 : CONVERSION KDB -> P12 (DANS LA SOURCE)
# ==============================================================================
log_msg "[START] D√©marrage du script de d√©ploiement SSL."

# V√©rification pr√©sence KDB Source
if [ ! -f "$SRC_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] Fichier KDB introuvable dans la source : $SRC_DIR"
    exit 1
fi

# D√©placement dans le dossier des outils IBM
cd "$GSK_DIR" || exit 1

# D√©tection automatique de l'outil (C ou Java)
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du fichier P12..."
$TOOL -cert -export \
    -db "$SRC_DIR/${BASE_NAME}.kdb" \
    -stashed \
    -label "$CERT_LABEL" \
    -target "$SRC_DIR/${BASE_NAME}.p12" \
    -target_type pkcs12 \
    -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then
    log_msg "[ERREUR] Echec de la conversion P12."
    exit 1
fi

# Correction droits du nouveau P12 source
chown was:web "$SRC_DIR/${BASE_NAME}.p12"
log_msg "[INFO] P12 g√©n√©r√© avec succ√®s dans le dossier source."

# ==============================================================================
# 4. ETAPE 2 : DEPLOIEMENT INTELLIGENT VERS DESTINATION
# ==============================================================================
log_msg "[DEPLOY] Traitement des fichiers vers : $DEST_DIR"

if [ ! -d "$DEST_DIR" ]; then
    log_msg "[ERREUR] Le dossier de destination n'existe pas."
    exit 1
fi

# Boucle sur les 3 types de fichiers √† copier
for EXT in kdb sth p12; do
    
    FILE_NAME="${BASE_NAME}.${EXT}"
    SRC_FILE="$SRC_DIR/$FILE_NAME"
    DEST_FILE="$DEST_DIR/$FILE_NAME"
    
    # V√©rification si le fichier source existe bien
    if [ -f "$SRC_FILE" ]; then
        
        # LOGIQUE INTELLIGENTE : UPDATE OU NEW
        if [ -f "$DEST_FILE" ]; then
            # Le fichier existe d√©j√† -> On fait un backup
            cp "$DEST_FILE" "${DEST_FILE}.bak"
            log_msg " -> [UPDATE] $FILE_NAME : Sauvegarde .bak cr√©√©e, fichier √©cras√©."
        else
            # Le fichier n'existe pas -> C'est une nouvelle installation
            log_msg " -> [NEW] $FILE_NAME : Fichier inexistant, cr√©ation."
        fi
        
        # Copie du fichier (√©crase si existant)
        cp -f "$SRC_FILE" "$DEST_FILE"
        
        # Application des droits was:web
        chown was:web "$DEST_FILE"
        chmod 640 "$DEST_FILE"
        
    else
        log_msg "[WARNING] Fichier source $FILE_NAME manquant, ignor√©."
    fi

done

log_msg "[SUCCES] Op√©ration termin√©e. Les fichiers sont √† jour dans Security."
exit 0
////////////////////// nouvelle solution avec transit /////////////////////////////////
#!/bin/bash

# ==============================================================================
# CONFIGURATION
# ==============================================================================

# 1. Dossier TEMPORAIRE (L√† o√π Horizon d√©pose les nouveaux fichiers)
TRANSIT_DIR="/opt/horizon/var/transit"

# 2. Dossier FINAL IHS (Front)
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl"

# 3. Dossier FINAL WAS/LIBERTY (Back)
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_backjava-prez-1/servers/sa-19382_certis_backjava-prez-1/resources/security"

# Outils et Noms
GSK_DIR="/apps/WebSphere/WebPlugins/bin"
BASE_NAME="certis-api.staging.echonet"
CERT_LABEL="certis-api.staging.echonet"
P12_PASSWORD="passQual1"
LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# EXECUTION
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

log_msg "[START] D√©marrage du d√©ploiement depuis TRANSIT."

# A. CONVERSION KDB -> P12 (Dans le dossier Transit)
cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du P12 dans le transit..."
$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" -stashed -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" -target_type pkcs12 -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then log_msg "[ERREUR] Conversion √©chou√©e."; exit 1; fi
chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12" # Droits temporaires

# B. FONCTION DE DEPLOIEMENT SECURISE
deploy_to() {
    TARGET_DIR=$1
    log_msg "[DEPLOY] Traitement vers : $TARGET_DIR"
    
    for EXT in kdb sth p12; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        if [ -f "$FINAL_FILE" ]; then
            # LE VRAI BACKUP EST ICI : On sauvegarde l'existant avant d'√©craser
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] Backup cr√©√© pour $EXT"
        else
            log_msg " -> [NEW] Nouvelle installation pour $EXT"
        fi
        
        # Copie du nouveau fichier
        cp -f "$NEW_FILE" "$FINAL_FILE"
        
        # Droits
        chown was:web "$FINAL_FILE"
        chmod 640 "$FINAL_FILE"
    done
}

# C. LANCEMENT DES DEPLOIEMENTS
deploy_to "$IHS_DIR"  # Mise √† jour du Front (IHS) avec backup !
deploy_to "$WAS_DIR"  # Mise √† jour du Back (Liberty) avec backup !

# D. NETTOYAGE (Optionnel)
# rm -f "$TRANSIT_DIR"/*
log_msg "[INFO] Nettoyage du dossier transit non effectu√© (s√©curit√©)."

log_msg "[SUCCES] D√©ploiement termin√© partout."
exit 0
/////////////// derniere ligne droite /////////////////////////////
# 1. Cr√©er le dossier de transit
mkdir -p /opt/horizon/var/transit

# 2. Cr√©er le script complet
cat << 'EOF' > /opt/horizon/scripts/convert_and_deploy.sh
#!/bin/bash

# ==============================================================================
# CONFIGURATION
# ==============================================================================
TRANSIT_DIR="/opt/horizon/var/transit"
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl"
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_backjava-prez-1/servers/sa-19382_certis_backjava-prez-1/resources/security"

GSK_DIR="/apps/WebSphere/WebPlugins/bin"
BASE_NAME="certis-api.staging.echonet"
CERT_LABEL="certis-api.staging.echonet"
P12_PASSWORD="passQual1"
LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# EXECUTION
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

log_msg "[START] D√©marrage du d√©ploiement depuis TRANSIT."

# A. CONVERSION KDB -> P12 (DANS LE TRANSIT)
cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du P12 dans le transit..."
$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" -stashed -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" -target_type pkcs12 -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then log_msg "[ERREUR] Conversion √©chou√©e."; exit 1; fi
chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12"

# B. FONCTION DE DEPLOIEMENT SECURISE
deploy_to() {
    TARGET_DIR=$1
    log_msg "[DEPLOY] Vers : $TARGET_DIR"
    
    # V√©rification que le dossier existe
    if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier cible introuvable : $TARGET_DIR"; return; fi

    for EXT in kdb sth p12; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        # SI LE FICHIER EXISTE DEJA -> BACKUP
        if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] $EXT (Backup .bak cr√©√©)"
        else
            log_msg " -> [NEW] $EXT (Nouvelle installation)"
        fi
        
        # COPIE ET DROITS
        cp -f "$NEW_FILE" "$FINAL_FILE"
        chown was:web "$FINAL_FILE"
        chmod 640 "$FINAL_FILE"
    done
}

# C. EXECUTION DES DEPLOIEMENTS
deploy_to "$IHS_DIR"  # Mise √† jour du Front (IHS)
deploy_to "$WAS_DIR"  # Mise √† jour du Back (Liberty)

log_msg "[SUCCES] Termin√©."
exit 0
EOF

# 3. Rendre ex√©cutable
chmod +x /opt/horizon/scripts/convert_and_deploy.sh
√âtape 2 : La Commande Horizon (Le D√©clencheur)
C'est ici que la magie op√®re.
Changement 1 : --destination-folder pointe maintenant vers /transit.
Changement 2 : --post-hook appelle le script ci-dessus.
Copiez-collez ceci dans votre terminal :
code
Bash
/opt/horizon/bin/horizon-cli automate enroll \
  --no-interactive \
  --automation-policy=automate-app-tls-server-365 \
  --target=generic \
  --auto-renew \
  --contact-email="abdoulaye.1.traore@externe.bnpparibas.com" \
  --dnsnames="certis-api.staging.echonet,s02v19932112.fr.net.intra" \
  --kdb="certis-api.staging.echonet.kdb" \
  --kdb-pwd="passQual1" \
  --kdb-alias="certis-api.staging.echonet" \
  --destination-folder="/opt/horizon/var/transit" \
  --post-hook="/opt/horizon/scripts/convert_and_deploy.sh"
R√©sum√© de ce qui va se passer quand vous appuierez sur Entr√©e :
Horizon t√©l√©charge le certificat.
Horizon cr√©e le .kdb et .sth dans /opt/horizon/var/transit.
Horizon lance le script /opt/horizon/scripts/convert_and_deploy.sh.
Le Script :
Convertit le KDB en P12 dans le dossier transit.
Va dans /applis/.../ssl, sauvegarde les vieux fichiers en .bak, et copie les nouveaux.
Va dans /applis/.../security, sauvegarde les vieux fichiers en .bak, et copie les nouveaux.
Applique les droits was:web partout.
C'est la solution d'automatisation compl√®te et s√©curis√©e !
//////////////////// solution cle en main /////////////////////////////
. Cr√©ation du script convert_and_deploy.sh
code
Bash
# 1. Cr√©ation des dossiers n√©cessaires
mkdir -p /opt/horizon/var/transit
mkdir -p /opt/horizon/scripts

# 2. Cr√©ation du fichier script via la commande cat
cat << 'EOF' > /opt/horizon/scripts/convert_and_deploy.sh
#!/bin/bash

# ==============================================================================
# 1. CONFIGURATION
# ==============================================================================

# Dossiers
TRANSIT_DIR="/opt/horizon/var/transit"
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/ssl"
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_backjava-prez-1/servers/sa-19382_certis_backjava-prez-1/resources/security"
GSK_DIR="/apps/WebSphere/WebPlugins/bin"

# Noms des fichiers et certificats
BASE_NAME="certis-api.staging.echonet"
CERT_LABEL="certis-api.staging.echonet"
P12_PASSWORD="passQual1"

# Log
LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# 2. FONCTION DE JOURNALISATION
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

# ==============================================================================
# 3. CONVERSION KDB -> P12 (DANS LE TRANSIT)
# ==============================================================================
log_msg "[START] D√©marrage du script Post-Hook."

# V√©rification que Horizon a bien d√©pos√© le KDB
if [ ! -f "$TRANSIT_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] Le fichier KDB est absent du dossier Transit : $TRANSIT_DIR"
    exit 1
fi

# D√©placement dans le dossier des outils IBM
cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du fichier P12 dans le Transit..."
$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" \
    -stashed \
    -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" \
    -target_type pkcs12 \
    -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then
    log_msg "[ERREUR] La conversion P12 a √©chou√©."
    exit 1
fi

# Droits temporaires pour lecture
chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12"

# ==============================================================================
# 4. FONCTION DE DEPLOIEMENT INTELLIGENT
# ==============================================================================
deploy_to() {
    TARGET_DIR=$1
    log_msg "[DEPLOY] Traitement vers : $TARGET_DIR"
    
    # V√©rification dossier cible
    if [ ! -d "$TARGET_DIR" ]; then
        log_msg "[ERREUR] Dossier cible introuvable : $TARGET_DIR"
        return
    fi

    # Boucle sur les 3 extensions
    for EXT in kdb sth p12; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        # LOGIQUE DE BACKUP
        if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] ${BASE_NAME}.${EXT} (Backup .bak cr√©√©)"
        else
            log_msg " -> [NEW] ${BASE_NAME}.${EXT} (Nouvelle installation)"
        fi
        
        # COPIE FORCEE
        cp -f "$NEW_FILE" "$FINAL_FILE"
        
        # APPLICATION DES DROITS (was:web)
        chown was:web "$FINAL_FILE"
        chmod 640 "$FINAL_FILE"
    done
}

# ==============================================================================
# 5. EXECUTION DES DEPLOIEMENTS
# ==============================================================================

# A. Mise √† jour du Front (IHS)
deploy_to "$IHS_DIR"

# B. Mise √† jour du Back (Liberty/WAS)
deploy_to "$WAS_DIR"

log_msg "[SUCCES] Op√©ration termin√©e."
exit 0
EOF

# 3. Rendre le script ex√©cutable
chmod +x /opt/horizon/scripts/convert_and_deploy.sh
2. Rappel de la commande Horizon √† lancer ensuite
Une fois le bloc ci-dessus coll√© et valid√©, lancez cette commande pour activer l'automatisation :
code
Bash
/opt/horizon/bin/horizon-cli automate enroll \
  --no-interactive \
  --automation-policy=automate-app-tls-server-365 \
  --target=generic \
  --auto-renew \
  --contact-email="abdoulaye.1.traore@externe.bnpparibas.com" \
  --dnsnames="certis-api.staging.echonet,s02v19932112.fr.net.intra" \
  --kdb="certis-api.staging.echonet.kdb" \
  --kdb-pwd="passQual1" \
  --kdb-alias="certis-api.staging.echonet" \
  --destination-folder="/opt/horizon/var/transit" \
  --post-hook="/opt/horizon/scripts/convert_and_deploy.sh"
  /////////////////////////lire le fichier .sth //////////////////
  ./gskcapicmd -cert -list \
  -db /applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/resources/security/certis.staging.echonet.kdb \
  -pw "passQual1"
  ///////////////////////// nettoyage //////////////////////
  # ==============================================================================
TRANSIT_DIR="/opt/horizon/var/transit"
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_frontjava-prez-1-ssl/ssl"
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/resources/security"
GSK_DIR="/apps/WebSphere/WebPlugins/bin"

BASE_NAME="certis.staging.echonet"
CERT_LABEL="certis.staging.echonet"
P12_PASSWORD="passQual1"

LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# 2. FONCTION LOG
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

# ==============================================================================
# 3. CONVERSION KDB -> P12 (DANS LE TRANSIT)
# ==============================================================================
log_msg "[START] D√©marrage du script Post-Hook."

# V√©rification pr√©sence KDB
if [ ! -f "$TRANSIT_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] KDB absent du transit : $TRANSIT_DIR"
    exit 1
fi

cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du fichier P12..."

# --- CORRECTION ICI : NETTOYAGE PREVENTIF ---
# On supprime le fichier P12 s'il existe d√©j√† pour √©viter l'erreur CTGSK3036W
if [ -f "$TRANSIT_DIR/${BASE_NAME}.p12" ]; then
    log_msg "[INFO] Suppression de l'ancien fichier P12 pr√©sent dans le transit."
    rm -f "$TRANSIT_DIR/${BASE_NAME}.p12"
fi
# ---------------------------------------------

$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" \
    -stashed \
    -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" \
    -target_type pkcs12 \
    -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then
    log_msg "[ERREUR] La conversion a √©chou√©."
    exit 1
fi

chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12"

# ==============================================================================
# 4. DEPLOIEMENT INTELLIGENT
# ==============================================================================
deploy_to() {
    TARGET_DIR=$1
    log_msg "[DEPLOY] Vers : $TARGET_DIR"
    
    if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier introuvable : $TARGET_DIR"; return; fi

    for EXT in kdb sth p12; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] $EXT (Backup fait)"
        else
            log_msg " -> [NEW] $EXT"
        fi
        
        cp -f "$NEW_FILE" "$FINAL_FILE"
        chown was:web "$FINAL_FILE"
        chmod 640 "$FINAL_FILE"
    done
}

deploy_to "$IHS_DIR"
deploy_to "$WAS_DIR"

log_msg "[SUCCES] Termin√©."
exit 0
//////////////////////// front et back /////////////////////////////////////

C'est une modification tr√®s pertinente. En effet, le serveur Web (Front / IHS) n'a besoin que du KDB et du STH. Le fichier P12 ne sert que pour le serveur d'application (Back / Liberty).
Pour adapter le script, nous allons rendre la fonction deploy_to plus intelligente : nous allons lui dire quels fichiers copier √† chaque fois.
Voici les modifications logiques :
Pour IHS (Front), on lui dira : "Copie seulement kdb et sth".
Pour WAS (Back), on lui dira : "Copie kdb, sth et p12".
Voici le script FINAL MODIFI√â (Copiez-collez tout le bloc) :
code
Bash
cat << 'EOF' > /opt/horizon/var/script/convert_deploy.sh
#!/bin/bash

# ==============================================================================
# 1. CONFIGURATION
# ==============================================================================
TRANSIT_DIR="/opt/horizon/var/transit"
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_frontjava-prez-1-ssl/ssl"
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/resources/security"
GSK_DIR="/apps/WebSphere/WebPlugins/bin"

BASE_NAME="certis.staging.echonet"
CERT_LABEL="certis.staging.echonet"
P12_PASSWORD="passQual1"

LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# 2. FONCTION LOG
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

# ==============================================================================
# 3. CONVERSION : KDB -> P12 (Toujours n√©cessaire pour le Backend)
# ==============================================================================
log_msg "[START] D√©marrage du script."

if [ ! -f "$TRANSIT_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] Le fichier KDB est absent du transit."
    exit 1
fi

cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du P12 √† partir du KDB..."

# Nettoyage pr√©ventif
if [ -f "$TRANSIT_DIR/${BASE_NAME}.p12" ]; then rm -f "$TRANSIT_DIR/${BASE_NAME}.p12"; fi

# Export KDB -> P12
$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" \
    -stashed \
    -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" \
    -target_type pkcs12 \
    -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then
    log_msg "[ERREUR] La conversion KDB -> P12 a √©chou√©."
    exit 1
fi

chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12"
log_msg "[INFO] P12 g√©n√©r√© avec succ√®s."

# ==============================================================================
# 4. DEPLOIEMENT FLEXIBLE (Modifi√©)
# ==============================================================================
deploy_to() {
    TARGET_DIR=$1
    EXTENSIONS=$2  # On r√©cup√®re la liste des extensions √† copier
    
    log_msg "[DEPLOY] Vers : $TARGET_DIR (Fichiers : $EXTENSIONS)"
    
    if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier introuvable : $TARGET_DIR"; return; fi

    # On ne boucle que sur les extensions demand√©es
    for EXT in $EXTENSIONS; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        # Backup
        if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] $EXT (Backup fait)"
        else
            log_msg " -> [NEW] $EXT"
        fi
        
        # Copie
        cp -f "$NEW_FILE" "$FINAL_FILE"
        chown was:web "$FINAL_FILE"
        chmod 640 "$FINAL_FILE"
    done
}

# ==============================================================================
# 5. EXECUTION CIBLEE
# ==============================================================================

# A. Pour le FRONT (IHS) : On ne copie que KDB et STH
deploy_to "$IHS_DIR" "kdb sth"

# B. Pour le BACK (Liberty) : On copie TOUT (KDB, STH et P12)
deploy_to "$WAS_DIR" "kdb sth p12"

log_msg "[SUCCES] Termin√©."
exit 0
EOF

chmod +x /opt/horizon/var/script/convert_deploy.sh
Ce qui a chang√© :
La fonction deploy_to accepte maintenant un deuxi√®me argument : la liste des extensions.
L'appel final (Section 5) est diff√©rent :
deploy_to "$IHS_DIR" "kdb sth" -> Le fichier P12 ne sera pas copi√© dans le dossier IHS.
deploy_to "$WAS_DIR" "kdb sth p12" -> Tous les fichiers seront copi√©s dans le dossier Liberty.
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.
//////////////////////////////////////////////// front /////////////////////////
TRANSIT_DIR="/opt/horizon/var/transit"
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_frontjava-prez-1-ssl/ssl"
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/resources/security"

BASE_NAME="certis.staging.echonet"
LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# 2. FONCTION LOG
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

log_msg "[START] D√©marrage du d√©ploiement (KDB/STH uniquement)."

# V√©rification KDB
if [ ! -f "$TRANSIT_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] Le fichier KDB est absent du transit."
    exit 1
fi

# ==============================================================================
# 3. (SECTION SUPPRIM√âE) : PLUS DE CONVERSION P12 ICI
# ==============================================================================
# Le bloc gskcapicmd a √©t√© retir√©.
# On passe directement au d√©ploiement des fichiers existants.

# ==============================================================================
# 4. DEPLOIEMENT (KDB et STH uniquement)
# ==============================================================================
deploy_to() {
    TARGET_DIR=$1
    log_msg "[DEPLOY] Vers : $TARGET_DIR"
    
    if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier introuvable : $TARGET_DIR"; return; fi

    # On ne traite que KDB et STH (puisque le P12 n'est pas g√©n√©r√©)
    for EXT in kdb sth; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        # Backup
        if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] $EXT (Backup fait)"
        else
            log_msg " -> [NEW] $EXT"
        fi
        
        # Copie
        cp -f "$NEW_FILE" "$FINAL_FILE"
        chown was:web "$FINAL_FILE"
        chmod 640 "$FINAL_FILE"
    done
}

# A. Front (IHS)
deploy_to "$IHS_DIR"

# B. Back (Liberty) - On y met aussi le KDB
deploy_to "$WAS_DIR"

log_msg "[SUCCES] KDB et STH d√©ploy√©s partout."
exit 0
EOF

chmod +x /opt/horizon/var/script/convert_deploy.sh
//////////////////////////// master deploy ////////////////////////////////////////////////

C'est une excellente id√©e ! "Diviser pour mieux r√©gner". Cela rendra la maintenance beaucoup plus facile.
Comme horizon-cli ne permet d'appeler qu'un seul script via l'option --script, nous allons proc√©der ainsi :
Cr√©er le script FRONT (IHS).
Cr√©er le script BACK (Liberty).
Cr√©er un petit script MA√éTRE (Master) qui lance les deux l'un apr√®s l'autre (c'est celui-ci qu'on donnera √† Horizon).
Voici la solution compl√®te.
1. Le Script FRONT (IHS)
Il ne fait que copier le KDB et le STH.
code
Bash
cat << 'EOF' > /opt/horizon/var/script/deploy_front.sh
#!/bin/bash
# === SCRIPT FRONT (IHS) ===

TRANSIT_DIR="/opt/horizon/var/transit"
TARGET_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_frontjava-prez-1-ssl/ssl"
BASE_NAME="certis.staging.echonet"
LOG_FILE="/opt/horizon/var/convert_deploy.log"

log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - [FRONT] $1" | tee -a "$LOG_FILE"; }

log_msg "--- D√©but traitement FRONT ---"

if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier cible introuvable"; exit 1; fi

# On ne traite que KDB et STH
for EXT in kdb sth; do
    NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
    FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
    
    if [ ! -f "$NEW_FILE" ]; then
        log_msg "[ERREUR] Fichier manquant dans transit : $NEW_FILE"
        exit 1
    fi

    if [ -f "$FINAL_FILE" ]; then
        cp "$FINAL_FILE" "${FINAL_FILE}.bak"
        log_msg " -> [UPDATE] $EXT (Backup cr√©√©)"
    else
        log_msg " -> [NEW] $EXT"
    fi
    
    cp -f "$NEW_FILE" "$FINAL_FILE"
    chown was:web "$FINAL_FILE"
    chmod 640 "$FINAL_FILE"
done

log_msg "--- Fin traitement FRONT (Succ√®s) ---"
exit 0
EOF
chmod +x /opt/horizon/var/script/deploy_front.sh
2. Le Script BACK (Liberty)
Il convertit en P12 et copie tout (KDB, STH, P12).
code
Bash
cat << 'EOF' > /opt/horizon/var/script/deploy_back.sh
#!/bin/bash
# === SCRIPT BACK (LIBERTY) ===

TRANSIT_DIR="/opt/horizon/var/transit"
TARGET_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/resources/security"
GSK_DIR="/apps/WebSphere/WebPlugins/bin"

BASE_NAME="certis.staging.echonet"
CERT_LABEL="certis.staging.echonet"
P12_PASSWORD="passQual1"
LOG_FILE="/opt/horizon/var/convert_deploy.log"

log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - [BACK] $1" | tee -a "$LOG_FILE"; }

log_msg "--- D√©but traitement BACK ---"

# 1. CONVERSION KDB -> P12 (Dans le transit)
cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

# Nettoyage pr√©ventif du P12
if [ -f "$TRANSIT_DIR/${BASE_NAME}.p12" ]; then rm -f "$TRANSIT_DIR/${BASE_NAME}.p12"; fi

log_msg "Conversion KDB vers P12..."
$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" -stashed \
    -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" -target_type pkcs12 -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then log_msg "[ERREUR] Conversion √©chou√©e"; exit 1; fi
chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12"

# 2. DEPLOIEMENT (KDB, STH, P12)
if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier cible introuvable"; exit 1; fi

for EXT in kdb sth p12; do
    NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
    FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
    
    if [ -f "$FINAL_FILE" ]; then
        cp "$FINAL_FILE" "${FINAL_FILE}.bak"
        log_msg " -> [UPDATE] $EXT (Backup cr√©√©)"
    else
        log_msg " -> [NEW] $EXT"
    fi
    
    cp -f "$NEW_FILE" "$FINAL_FILE"
    chown was:web "$FINAL_FILE"
    chmod 640 "$FINAL_FILE"
done

log_msg "--- Fin traitement BACK (Succ√®s) ---"
exit 0
EOF
chmod +x /opt/horizon/var/script/deploy_back.sh
3. Le Script MA√éTRE (Celui qu'on donne √† Horizon)
C'est le chef d'orchestre.
code
Bash
cat << 'EOF' > /opt/horizon/var/script/master_deploy.sh
#!/bin/bash

LOG_FILE="/opt/horizon/var/convert_deploy.log"
echo "========================================================" >> $LOG_FILE
echo "$(date) - [MASTER] D√©marrage du d√©ploiement global" >> $LOG_FILE

# 1. Lancement du Front
/opt/horizon/var/script/deploy_front.sh
if [ $? -ne 0 ]; then
    echo "$(date) - [MASTER] ERREUR CRITIQUE sur le FRONT. Arr√™t." >> $LOG_FILE
    exit 1
fi

# 2. Lancement du Back
/opt/horizon/var/script/deploy_back.sh
if [ $? -ne 0 ]; then
    echo "$(date) - [MASTER] ERREUR CRITIQUE sur le BACK." >> $LOG_FILE
    exit 1
fi

echo "$(date) - [MASTER] Tout est termin√© avec succ√®s." >> $LOG_FILE
exit 0
EOF
chmod +x /opt/horizon/var/script/master_deploy.sh
Comment utiliser √ßa ?
Dans votre commande Horizon, vous pointez maintenant uniquement vers le script ma√Ætre :
--script="/opt/horizon/var/script/master_deploy.sh"
Quand Horizon se lancera :
Il cr√©era le KDB dans le dossier Transit.
Il appellera master_deploy.sh.
Le ma√Ætre appellera deploy_front.sh (copie IHS).
Le ma√Ætre appellera deploy_back.sh (conversion + copie Liberty).
////////////////////script du front ////////////////////////

C'est not√©. Voici le script d√©di√© uniquement au Front (IHS).
Il ne fait que prendre les fichiers .kdb et .sth g√©n√©r√©s par Horizon dans le dossier transit et les installe proprement sur le serveur Web avec backup et permissions.
Script : deploy_front.sh
Copiez ce bloc dans votre terminal :
code
Bash
cat << 'EOF' > /opt/horizon/var/script/deploy_front.sh
#!/bin/bash

# ==============================================================================
# CONFIGURATION DU FRONT (IHS)
# ==============================================================================
TRANSIT_DIR="/opt/horizon/var/transit"
# Votre dossier cible pour le Front
TARGET_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_frontjava-prez-1-ssl/ssl"

BASE_NAME="certis.staging.echonet"
LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# EXECUTION
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - [FRONT] $1" | tee -a "$LOG_FILE"; }

log_msg "--- D√©marrage d√©ploiement FRONT (KDB/STH) ---"

# 1. V√©rifications de s√©curit√©
if [ ! -d "$TARGET_DIR" ]; then
    log_msg "[ERREUR] Dossier cible introuvable : $TARGET_DIR"
    exit 1
fi

if [ ! -f "$TRANSIT_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] Fichier KDB absent du transit."
    exit 1
fi

# 2. Boucle de d√©ploiement (Seulement KDB et STH)
for EXT in kdb sth; do
    NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
    FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
    
    # A. Backup de l'existant
    if [ -f "$FINAL_FILE" ]; then
        cp "$FINAL_FILE" "${FINAL_FILE}.bak"
        log_msg " -> [UPDATE] $EXT (Backup .bak cr√©√©)"
    else
        log_msg " -> [NEW] $EXT (Nouvelle installation)"
    fi
    
    # B. Copie du nouveau fichier
    cp -f "$NEW_FILE" "$FINAL_FILE"
    
    # C. Permissions (was:web + lecture)
    chown was:web "$FINAL_FILE"
    chmod 640 "$FINAL_FILE"
done

log_msg "--- D√©ploiement FRONT termin√© avec succ√®s ---"
exit 0
EOF

# Rendre ex√©cutable
chmod +x /opt/horizon/var/script/deploy_front.sh
Comment l'utiliser avec Horizon ?
Dans votre commande d'enr√¥lement, pointez simplement vers ce fichier :
--script="/opt/horizon/var/script/deploy_front.sh"
////////////////////////////////////////////////////complemenent //////////////////
TRANSIT_DIR="/opt/horizon/var/transit"

# Dossiers Cibles
IHS_DIR="/applis/19382-certi-00/ihs/sw-19382_certis_frontjava-prez-1-ssl/ssl"
WAS_DIR="/applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/resources/security"

# Outils
GSK_DIR="/apps/WebSphere/WebPlugins/bin"
IHS_BIN="/apps/WebSphere/WebServer/bin/apachectl"

# Noms et Mots de passe
BASE_NAME="certis.staging.echonet"
CERT_LABEL="certis.staging.echonet"
P12_PASSWORD="passQual1"

LOG_FILE="/opt/horizon/var/convert_deploy.log"

# ==============================================================================
# 2. FONCTION LOG
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

log_msg "--- D√©marrage du script (Mode 644) ---"

# ==============================================================================
# 3. CONVERSION : KDB -> P12
# ==============================================================================
if [ ! -f "$TRANSIT_DIR/${BASE_NAME}.kdb" ]; then
    log_msg "[ERREUR] KDB absent du transit."
    exit 1
fi

cd "$GSK_DIR" || exit 1
if [ -f "./gskcapicmd" ]; then TOOL="./gskcapicmd"; else TOOL="./gskcmd"; fi

log_msg "[CONVERT] G√©n√©ration du P12..."

# Nettoyage pr√©ventif
if [ -f "$TRANSIT_DIR/${BASE_NAME}.p12" ]; then rm -f "$TRANSIT_DIR/${BASE_NAME}.p12"; fi

# Export
$TOOL -cert -export \
    -db "$TRANSIT_DIR/${BASE_NAME}.kdb" \
    -stashed \
    -label "$CERT_LABEL" \
    -target "$TRANSIT_DIR/${BASE_NAME}.p12" \
    -target_type pkcs12 \
    -target_pw "$P12_PASSWORD"

if [ $? -ne 0 ]; then
    log_msg "[ERREUR] La conversion a √©chou√©."
    exit 1
fi

# Droit large sur le fichier de transit aussi
chmod 644 "$TRANSIT_DIR/${BASE_NAME}.p12"
log_msg "[OK] Fichier P12 cr√©√©."

# ==============================================================================
# 4. FONCTION DE DEPLOIEMENT (AVEC CHMOD 644)
# ==============================================================================
deploy_to() {
    TARGET_DIR=$1
    EXTENSIONS=$2 
    
    log_msg "[DEPLOY] Vers : $TARGET_DIR"
    
    if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier introuvable : $TARGET_DIR"; return; fi

    for EXT in $EXTENSIONS; do
        NEW_FILE="$TRANSIT_DIR/${BASE_NAME}.${EXT}"
        FINAL_FILE="$TARGET_DIR/${BASE_NAME}.${EXT}"
        
        # Backup
        if [ -f "$FINAL_FILE" ]; then
            cp "$FINAL_FILE" "${FINAL_FILE}.bak"
            log_msg " -> [UPDATE] $EXT (Backup fait)"
        else
            log_msg " -> [NEW] $EXT"
        fi
        
        # Copie
        cp -f "$NEW_FILE" "$FINAL_FILE"
        
        # --- PERMISSIONS DEMANDEES ---
        chown was:web "$FINAL_FILE"
        chmod 644 "$FINAL_FILE"    # <--- C'est ici que √ßa change (avant c'√©tait 640)
        # -----------------------------
    done
}

# ==============================================================================
# 5. EXECUTION DES DEPLOIEMENTS
# ==============================================================================

# A. FRONT (IHS/SSL) : kdb, sth, p12
deploy_to "$IHS_DIR" "kdb sth p12"

# B. BACK (WAS/Security) : kdb, sth, p12
deploy_to "$WAS_DIR" "kdb sth p12"

# ==============================================================================
# 6. RELOAD DU SERVEUR FRONT
# ==============================================================================
log_msg "[RELOAD] Rechargement du serveur IHS..."

if [ -f "$IHS_BIN" ]; then
    $IHS_BIN -k graceful
    if [ $? -eq 0 ]; then
        log_msg "[SUCCES] Serveur recharg√©."
    else
        log_msg "[ERREUR] Echec du reload."
        exit 1
    fi
fi

log_msg "--- Op√©ration termin√©e ---"
exit 0

//////////////////////////// script websso ////////////////////////////////////////
cat << 'EOF' > /opt/horizon/var/script/deploy_websso_jks.sh
#!/bin/bash

# ==============================================================================
# CONFIGURATION WEBSSO (JKS)
# ==============================================================================
TRANSIT_DIR="/opt/horizon/var/transit"
# Dossier de configuration du serveur
TARGET_DIR="/applis/19382-certi-00/config"

# Fichier de configuration Liberty (Pour le Reload)
# (Chemin d√©duit de vos captures pr√©c√©dentes)
SERVER_XML="/applis/19382-certi-00/wlc/sa-19382_certis_frontjava-prez-1/servers/sa-19382_certis_frontjava-prez-1/server.xml"

BASE_NAME="certis.staging.websso"
P12_FILE="${BASE_NAME}.p12"
JKS_FILE="${BASE_NAME}.jks"

ALIAS="certis.staging.websso"
JKS_PASSWORD="passQual1" 

# Recherche de Keytool
if [ -f "/apps/WebSphere/WebPlugins/java/8.0/jre/bin/keytool" ]; then
    KEYTOOL="/apps/WebSphere/WebPlugins/java/8.0/jre/bin/keytool"
else
    KEYTOOL="keytool"
fi

LOG_FILE="/opt/horizon/var/deploy_websso.log"

# ==============================================================================
# EXECUTION
# ==============================================================================
log_msg() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"; }

log_msg "--- D√©marrage d√©ploiement WEBSSO (JKS) ---"

# 1. Conversion P12 -> JKS
if [ ! -f "$TRANSIT_DIR/$P12_FILE" ]; then
    log_msg "[ERREUR] P12 absent du transit."
    exit 1
fi

log_msg "[CONVERT] Cr√©ation du JKS..."
if [ -f "$TRANSIT_DIR/$JKS_FILE" ]; then rm -f "$TRANSIT_DIR/$JKS_FILE"; fi

$KEYTOOL -importkeystore \
    -srckeystore "$TRANSIT_DIR/$P12_FILE" -srcstoretype pkcs12 -srcstorepass "$JKS_PASSWORD" \
    -destkeystore "$TRANSIT_DIR/$JKS_FILE" -deststoretype JKS -deststorepass "$JKS_PASSWORD" \
    -destalias "$ALIAS" -noprompt

if [ $? -ne 0 ]; then
    log_msg "[ERREUR] La conversion keytool a √©chou√©."
    exit 1
fi

# 2. D√©ploiement
log_msg "[DEPLOY] Vers : $TARGET_DIR"

if [ ! -d "$TARGET_DIR" ]; then log_msg "[ERREUR] Dossier cible introuvable"; exit 1; fi

FINAL_FILE="$TARGET_DIR/$JKS_FILE"
NEW_FILE="$TRANSIT_DIR/$JKS_FILE"

# Backup
if [ -f "$FINAL_FILE" ]; then
    cp "$FINAL_FILE" "${FINAL_FILE}.bak"
    log_msg " -> [UPDATE] Backup r√©alis√© (.bak)"
else
    log_msg " -> [NEW] Nouvelle installation"
fi

# Copie & Droits
cp -f "$NEW_FILE" "$FINAL_FILE"
chown was:web "$FINAL_FILE"
chmod 644 "$FINAL_FILE"

# ==============================================================================
# 3. RECHARGEMENT (RELOAD) LIBERTY
# ==============================================================================
log_msg "[RELOAD] Rafra√Æchissement de la configuration Liberty..."

if [ -f "$SERVER_XML" ]; then
    # La commande 'touch' met √† jour la date du fichier.
    # Liberty surveille ce fichier et va recharger la config automatiquement.
    touch "$SERVER_XML"
    log_msg "[SUCCES] Fichier server.xml 'touch√©'. Liberty va recharger le certificat."
else
    log_msg "[WARNING] Impossible de trouver server.xml pour le reload."
    log_msg "Chemin cherch√© : $SERVER_XML"
    # On ne met pas exit 1 car le certificat est quand m√™me copi√©
fi

log_msg "[SUCCES] Op√©ration termin√©e."
exit 0