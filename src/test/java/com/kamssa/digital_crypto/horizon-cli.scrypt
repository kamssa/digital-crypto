
Voici un exemple concret, propre et s√©curis√© pour votre serveur IBM HTTP Server.
Ce script fait un peu plus que juste red√©marrer : il v√©rifie que la commande existe et il √©crit dans le journal syst√®me (logs) pour laisser une trace de son ex√©cution.
√âtape 1 : Cr√©er le fichier
Ouvrez votre √©diteur (en tant que root) :
code
Bash
vi /opt/horizon/scripts/reload_ihs.sh
√âtape 2 : Coller le contenu suivant
(Copiez tout le bloc ci-dessous)
code
Bash
#!/bin/bash

# --- CONFIGURATION ---
# Chemin vers la commande de contr√¥le d'IBM HTTP Server
# V√©rifiez que ce chemin est correct sur votre machine (c'est le standard IBM)
IHS_BIN="/opt/IBM/HTTPServer/bin/apachectl"

# --- EXECUTION ---

# 1. On √©crit la date dans les logs pour dire qu'on commence
echo "$(date) - Horizon-CLI : Demande de rechargement du certificat SSL..." >> /tmp/horizon_reload.log

# 2. V√©rification que le binaire existe
if [ -f "$IHS_BIN" ]; then
    
    # 3. Lancement du rechargement "graceful" 
    # (Cela recharge la config et les certificats sans couper les utilisateurs connect√©s)
    $IHS_BIN -k graceful
    
    # V√©rification du r√©sultat
    if [ $? -eq 0 ]; then
        echo "$(date) - SUCCES : Serveur Web recharge avec succes." >> /tmp/horizon_reload.log
    else
        echo "$(date) - ERREUR : Echec du rechargement du serveur Web." >> /tmp/horizon_reload.log
        exit 1
    fi

else
    echo "$(date) - ERREUR : Le fichier $IHS_BIN est introuvable." >> /tmp/horizon_reload.log
    exit 1
fi

exit 0
√âtape 3 : Rendre le script ex√©cutable
C'est obligatoire, sinon horizon-cli ne pourra pas le lancer.
code
Bash
chmod +x /opt/horizon/scripts/reload_ihs.sh
√âtape 4 : Tester le script
Avant de l'int√©grer √† votre commande horizon, testez-le manuellement pour voir s'il ne fait pas d'erreur :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
Puis v√©rifiez le petit fichier de log qu'il a cr√©√© :
code
Bash
cat /tmp/horizon_reload.log
Si vous voyez "SUCCES", c'est parfait.
Comment l'utiliser dans votre commande Horizon ?
Dans la commande longue que vous construisez, √† la fin, pour le param√®tre script, vous mettrez simplement :
--post-hook="/opt/horizon/scripts/reload_ihs.sh"
(Note : parfois le param√®tre s'appelle --script ou --exec, v√©rifiez sur votre page wiki, mais le principe reste le chemin vers ce fichier).
/////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
Voici la proc√©dure compl√®te, moderne et automatis√©e, pour installer un certificat SSL sur votre serveur IBM HTTP Server (IHS) version 9 en utilisant horizon-cli.
Cette m√©thode remplace la "vieille" m√©thode manuelle (KDB) et garantit que le certificat se renouvellera tout seul l'ann√©e prochaine.
Phase 1 : Pr√©paration de l'automatisation (Le Script)
Avant de cr√©er le certificat, on pr√©pare le petit script qui servira √† recharger le serveur automatiquement lors des futurs renouvellements.
1. Cr√©er le fichier du script :
code
Bash
vi /opt/horizon/scripts/reload_ihs.sh
(Si le dossier scripts n'existe pas, cr√©ez-le avec mkdir -p /opt/horizon/scripts)
2. Coller ce contenu dedans :
Ce script dit au serveur Web de relire sa configuration sans couper les utilisateurs connect√©s.
code
Bash
#!/bin/bash
# Chemin vers la commande de contr√¥le IHS (A v√©rifier sur votre serveur)
IHS_BIN="/opt/IBM/HTTPServer/bin/apachectl"

# Ecriture dans un log pour le suivi
echo "$(date) - Horizon : Demande de rechargement..." >> /tmp/horizon_reload.log

if [ -f "$IHS_BIN" ]; then
    $IHS_BIN -k graceful
    if [ $? -eq 0 ]; then
        echo "$(date) - SUCCES : Serveur recharge." >> /tmp/horizon_reload.log
    else
        echo "$(date) - ERREUR : Echec du rechargement." >> /tmp/horizon_reload.log
        exit 1
    fi
else
    echo "$(date) - ERREUR : Binaire apachectl introuvable." >> /tmp/horizon_reload.log
    exit 1
fi
3. Rendre le script ex√©cutable (Obligatoire) :
code
Bash
chmod +x /opt/horizon/scripts/reload_ihs.sh
Phase 2 : Cr√©ation du certificat avec Horizon
Nous allons g√©n√©rer les fichiers .pem (certificat) et .key (cl√© priv√©e).
1. Construire la commande :
Remplacez VOTRE_SERVEUR par le vrai nom (ex: s02v19932112.fr.net.intra).
code
Bash
/opt/horizon/bin/horizon-cli automate enroll \
  --no-interactive \
  --automation-policy=automate-app-tls-server-365 \
  --target=generic \
  --auto-renew \
  --dnsnames="VOTRE_SERVEUR" \
  --contact-email="votre.email@echonet.net" \
  --post-hook="/opt/horizon/scripts/reload_ihs.sh"
Explication :
--target=generic : G√©n√®re des fichiers simples .pem et .key (lisibles par IHS 9).
--post-hook : Lie le script cr√©√© en Phase 1.
--auto-renew : Active le renouvellement automatique.
2. Noter le chemin des fichiers :
√Ä la fin de l'ex√©cution, Horizon va vous dire o√π il a mis les fichiers. Habituellement c'est dans :
/opt/horizon/var/generic/
Notez bien les noms exacts (ex: cert.pem, privkey.key, chain.pem).
Phase 3 : Configuration du Serveur Web (IHS)
C'est l'√©tape o√π on dit √† IBM HTTP Server : "Arr√™te de chercher un fichier KDB compliqu√©, et utilise ces nouveaux fichiers PEM".
1. Ouvrir le fichier de configuration :
code
Bash
vi /opt/IBM/HTTPServer/conf/httpd.conf
(Chemin standard, sinon utilisez menu_web > config)
2. Trouver et modifier la section SSL (<VirtualHost *:443>) :
Vous devez commenter (mettre un # devant) l'ancienne ligne KeyFile et ajouter les 3 nouvelles lignes pointant vers vos fichiers Horizon.
code
Apache
<VirtualHost *:443>
    SSLEnable

    # --- ANCIENNE CONFIG (A commenter) ---
    # KeyFile /applis/..../quelquechose.kdb
    
    # --- NOUVELLE CONFIG HORIZON (A ajouter) ---
    # 1. Le certificat public
    SSLCertificateFile /opt/horizon/var/generic/cert.pem
    
    # 2. La cl√© priv√©e
    SSLCertificateKeyFile /opt/horizon/var/generic/privkey.key
    
    # 3. La cha√Æne de certification (CA)
    SSLCertificateChainFile /opt/horizon/var/generic/chain.pem

    # (Assurez-vous que les noms de fichiers correspondent exactement 
    # √† ceux g√©n√©r√©s √† la Phase 2)
    
</VirtualHost>
Phase 4 : D√©marrage et V√©rification
Tout est pr√™t, il faut maintenant appliquer les changements.
1. Red√©marrer le serveur Web :
Le plus simple pour vous est d'utiliser le menu.
Tapez menu_web.
Faites Stop.
Faites Start.
(Ceci est n√©cessaire la premi√®re fois car on a modifi√© le fichier httpd.conf. Les prochaines fois, le script s'en chargera tout seul).
2. V√©rifier que √ßa marche :
V√©rifiez le statut : Assurez-vous que le serveur est "RUNNING" dans le menu.
Test local :
code
Bash
curl -v -k https://localhost/
Regardez si vous voyez une ligne Server certificate: avec les bonnes dates.
R√©sum√©
Vous avez maintenant :
‚úÖ G√©n√©r√© un certificat valide.
‚úÖ Configur√© votre serveur Web pour l'utiliser.
‚úÖ Mis en place un script pour que, l'ann√©e prochaine, vous n'ayez rien √† faire (Horizon t√©l√©chargera le nouveau certif et lancera le script de reload tout seul).
/////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////

C'est parti ! Voici la proc√©dure d√©finitive et sur-mesure pour votre serveur.
J'ai int√©gr√© les chemins exacts que nous avons d√©couverts gr√¢ce √† vos captures d'√©cran (ps -ef). Vous pouvez suivre ces √©tapes une par une en toute confiance.
√âtape 1 : Cr√©ation du script de rechargement automatique
Ce script servira √† horizon-cli pour dire au serveur : "J'ai renouvel√© le certificat, prends-le en compte !" sans couper vos utilisateurs.
Cr√©ez le dossier (s'il n'existe pas) et le fichier :
code
Bash
mkdir -p /opt/horizon/scripts
vi /opt/horizon/scripts/reload_ihs.sh
Copiez ce contenu exact (avec le bon chemin que nous avons trouv√©) :
code
Bash
#!/bin/bash

# --- CONFIGURATION (Chemin trouv√© via votre ps -ef) ---
IHS_BIN="/apps/WebSphere/WebServer/bin/apachectl"

# --- LOGS ---
LOG_FILE="/tmp/horizon_reload.log"
echo "$(date) - Horizon : Demande de rechargement SSL..." >> $LOG_FILE

# --- EXECUTION ---
if [ -f "$IHS_BIN" ]; then
    # On lance un reload "graceful" (douceur)
    $IHS_BIN -k graceful
    
    if [ $? -eq 0 ]; then
        echo "$(date) - SUCCES : Le serveur Web a recharg√© la config." >> $LOG_FILE
    else
        echo "$(date) - ERREUR : La commande a √©chou√©." >> $LOG_FILE
        exit 1
    fi
else
    echo "$(date) - ERREUR : Le fichier $IHS_BIN est introuvable." >> $LOG_FILE
    exit 1
fi
Rendez le script ex√©cutable (Obligatoire) :
code
Bash
chmod +x /opt/horizon/scripts/reload_ihs.sh
Testez-le tout de suite :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
(V√©rifiez ensuite avec cat /tmp/horizon_reload.log que vous avez bien un message de SUCC√àS).
√âtape 2 : G√©n√©ration du certificat avec Horizon
On g√©n√®re les fichiers .pem (lisibles) au lieu des .kdb (compliqu√©s).
Remplacez VOTRE_SERVEUR par le nom DNS complet de la machine (celui utilis√© dans l'URL, ex: s02v19932112.fr.net.intra ou un alias).
code
Bash
/opt/horizon/bin/horizon-cli automate enroll \
  --no-interactive \
  --automation-policy=automate-app-tls-server-365 \
  --target=generic \
  --auto-renew \
  --dnsnames="VOTRE_SERVEUR" \
  --contact-email="votre.email@echonet.net" \
  --post-hook="/opt/horizon/scripts/reload_ihs.sh"
Notez le r√©sultat : √Ä la fin, la commande va vous dire : "Certificate enrolled successfully". Elle va lister les fichiers cr√©√©s dans /opt/horizon/var/generic/.
Certificat : cert.pem (ou le nom du serveur.pem)
Cl√© : privkey.key (ou le nom du serveur.key)
Cha√Æne : chain.pem
√âtape 3 : Configuration du serveur Web (Le lien)
Nous allons modifier le fichier de configuration que nous avons identifi√© gr√¢ce √† votre capture d'√©cran.
Ouvrez le fichier :
code
Bash
vi /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf
Cherchez la section <VirtualHost *:443> (c'est souvent vers la fin du fichier).
Modifiez comme ceci :
Mettez un # devant la ligne KeyFile (pour la d√©sactiver).
Ajoutez les 3 lignes SSL qui pointent vers vos nouveaux fichiers.
code
Apache
<VirtualHost *:443>
    SSLEnable
    
    # --- ANCIENNE CONFIGURATION (On d√©sactive le KDB) ---
    # KeyFile /applis/19382-certi-00/ihs/.../quelquechose.kdb

    # --- NOUVELLE CONFIGURATION HORIZON ---
    # Adaptez les noms de fichiers selon ce que l'√©tape 2 a g√©n√©r√©
    
    # 1. Le certificat public
    SSLCertificateFile /opt/horizon/var/generic/cert.pem
    
    # 2. La cl√© priv√©e
    SSLCertificateKeyFile /opt/horizon/var/generic/privkey.key
    
    # 3. La cha√Æne de certification
    SSLCertificateChainFile /opt/horizon/var/generic/chain.pem
    
    # ... le reste de la config ne change pas ...
</VirtualHost>
√âtape 4 : V√©rification et Validation
Avant de crier victoire, on v√©rifie que le fichier de config ne contient pas d'erreur de frappe.
V√©rification de la syntaxe :
code
Bash
/apps/WebSphere/WebServer/bin/apachectl -t
Si √ßa r√©pond Syntax OK, c'est parfait !
Si √ßa r√©pond une erreur, relisez le fichier httpd.conf (v√©rifiez les chemins des fichiers .pem et .key).
Application finale :
Lancez votre script une derni√®re fois pour appliquer la config :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
Test Final :
Essayez d'acc√©der √† votre site en HTTPS ou faites un curl local :
code
Bash
curl -v -k https://localhost/
üéâ F√©licitations ! Votre serveur est maintenant s√©curis√© avec une m√©thode moderne.
Le serveur utilise des fichiers standards.
L'an prochain, horizon-cli renouvellera le
 fichier tout seul et lancera le script de reload sans que vous n'ayez rien √† faire.
 
 /////////////////
 cp /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf.bak /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf
 
 /////////////////////// process avec .kdb ///////////////////////////////////////////////////////////////
 
C'est une excellente question et la capture d'√©cran arrive √† point nomm√© !
Oui, c'est tout √† fait possible. IBM HTTP Server est "n√©" pour utiliser des fichiers .kdb.
Sur votre image, je vois que vous avez r√©ussi √† g√©n√©rer les fichiers :
certis-api.staging.echonet.kdb (Le coffre-fort)
certis-api.staging.echonet.sth (La cl√© du coffre)
Voici la proc√©dure exacte pour configurer votre serveur avec ces fichiers, en tenant compte de ce que je vois sur votre √©cran.
√âtape 1 : ‚ö†Ô∏è Probl√®me de droits (CRITIQUE)
Regardez votre capture d'√©cran :
Le processus httpd tourne avec l'utilisateur was (colonnes du haut).
Vos fichiers .kdb et .sth appartiennent √† root (lignes du bas).
Cons√©quence : Le serveur ne pourra pas lire le fichier et plantera au d√©marrage.
Solution :
Vous devez changer le propri√©taire des fichiers. Tapez cette commande dans le dossier actuel :
code
Bash
chown was:web certis-api.staging.echonet.*
(Cela donne les droits √† l'utilisateur was et au groupe web).
√âtape 2 : Trouver le "Label" (L'√©tiquette)
Dans un fichier .pem, il n'y a qu'un seul certificat. Dans un .kdb, il peut y en avoir plusieurs. Le serveur a besoin de savoir quel est le "nom interne" (alias) du certificat √† utiliser.
Vous avez la chance d'avoir l'outil gskcapicmd juste sous vos yeux (dans ce dossier). Utilisez-le pour lire le contenu du KDB :
code
Bash
./gskcapicmd -cert -list -db certis-api.staging.echonet.kdb -stashed
Le r√©sultat ressemblera √† ceci :
code
Text
Certificates found
* default, - personal, ! trusted
-   mon_certificat_alias
!   DigiCertCA
Notez bien le nom qui se trouve √† la ligne "personal" (ex: mon_certificat_alias ou souvent le nom DNS du serveur).
√âtape 3 : Configurer le serveur (httpd.conf)
Maintenant, on modifie le cerveau du serveur pour lui dire : "Utilise ce KDB".
1. Ouvrez le fichier de config :
(Utilisez le chemin trouv√© pr√©c√©demment)
code
Bash
vi /applis/19382-certi-00/ihs/sw-19382_certis_backjava-prez-1/conf/httpd.conf
2. Cherchez la section <VirtualHost *:443> et modifiez :
code
Apache
<VirtualHost *:443>
    SSLEnable

    # --- DESACTIVEZ LES LIGNES PEM (Si vous les aviez mises) ---
    # SSLCertificateFile ...
    # SSLCertificateKeyFile ...
    
    # --- ACTIVEZ LA CONFIGURATION KDB ---
    
    # 1. Le chemin vers votre fichier KDB (celui de la photo)
    KeyFile /apps/WebSphere/WebPlugins/bin/certis-api.staging.echonet.kdb
    
    # 2. Le nom de l'√©tiquette (trouv√© √† l'√©tape 2)
    SSLServerCert VOTRE_ALIAS_ICI
    
</VirtualHost>
Note sur l'emplacement : Sur la photo, vos fichiers sont dans /apps/WebSphere/WebPlugins/bin. Pour un test, c'est OK. Mais pour la "vraie vie" (Prod), il est plus propre de les d√©placer dans un dossier d√©di√© aux certificats (ex: /applis/19382-certi-00/ssl/) pour ne pas les m√©langer avec les ex√©cutables syst√®me.
√âtape 4 : Appliquer
V√©rifiez la syntaxe :
code
Bash
/apps/WebSphere/WebServer/bin/apachectl -t
Red√©marrez (ou Reload) :
Utilisez votre script ou le menu :
code
Bash
/opt/horizon/scripts/reload_ihs.sh
R√©sum√© pour l'automatisation
Si vous choisissez cette m√©thode (KDB) :
Le serveur fonctionnera parfaitement.
MAIS l'automatisation horizon-cli sera cass√©e.
L'ann√©e prochaine, Horizon g√©n√©rera des .pem.
Votre serveur, lui, attendra un .kdb.
Il faudra donc, dans votre script reload_ihs.sh, ajouter des lignes de commandes complexes (avec gskcapicmd) pour convertir automatiquement les nouveaux PEM en KDB avant de relancer le serveur.
C'est pourquoi, si vous avez le choix, la m√©thode .pem (native IHS 9) reste la plus simple.
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.
